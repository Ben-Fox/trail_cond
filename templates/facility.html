{% extends "base.html" %}
{% block title %}Facility Details{% endblock %}
{% block content %}
<div class="facility-page" id="facility-page" data-id="{{ facility_id }}">
    <div class="facility-loading">Loading facility details...</div>
</div>
{% endblock %}
{% block scripts %}
<script src="/static/js/map.js"></script>
<script src="/static/js/reports.js"></script>
<script>
const facilityId = '{{ facility_id }}';

const SVG = {
    clipboard: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>',
    compass: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88"/></svg>',
    target: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
    accessible: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="4" r="2"/><path d="M9 22l3-9 3 9"/><path d="M7 12h10"/></svg>',
    binoculars: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="7" cy="17" r="4"/><circle cx="17" cy="17" r="4"/><path d="M7 13V5a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v8"/><path d="M17 13V5a2 2 0 0 0-2-2h0a2 2 0 0 0-2 2v8"/></svg>',
    edit: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4z"/></svg>',
    chat: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
    mapPin: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>',
    sun: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
    cloud: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z"/></svg>',
    snowflake: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/><line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/></svg>',
    phone: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
    thermometer: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>',
    arrowUp: '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>',
    arrowDown: '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',
    checkCircle: '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    alertTriangle: '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    xCircle: '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
};

const statusIcons = { 'open': SVG.checkCircle, 'partially_open': SVG.alertTriangle, 'closed': SVG.xCircle };

async function loadFacility() {
    const page = document.getElementById('facility-page');
    try {
        const res = await fetch(`/api/facility/${facilityId}`);
        const data = await res.json();
        if (data.error) { page.innerHTML = `<p class="error">Error: ${data.error}</p>`; return; }
        
        const summary = data.condition_summary;
        const statusClass = summary ? ({'open':'good','partially_open':'caution','closed':'bad'}[summary.status]||'unknown') : 'unknown';
        const statusLabel = summary ? summary.status.replace('_',' ') : 'No reports yet';
        
        let mediaHtml = '';
        if (data.media && data.media.length) {
            mediaHtml = `<div class="facility-gallery">${data.media.slice(0,4).map(m=>`<img src="${m.url}" alt="${m.title}" loading="lazy">`).join('')}</div>`;
        }
        
        page.innerHTML = `
            <div class="facility-header">
                <div>
                    <h1>${data.name}</h1>
                    <span class="badge badge-${statusClass}">${statusLabel}</span>
                    ${data.ada === 'Yes' ? '<span class="badge badge-ada">' + SVG.accessible + ' Accessible</span>' : ''}
                    <p class="facility-type">${data.type || ''}</p>
                </div>
            </div>
            ${mediaHtml}
            <div class="facility-grid">
                <div class="facility-main">
                    <div class="card">
                        <h2>${SVG.clipboard} Description</h2>
                        <div class="description">${data.description || 'No description available.'}</div>
                    </div>
                    ${data.directions ? `<div class="card"><h2>${SVG.compass} Directions</h2><p>${data.directions}</p></div>` : ''}
                    ${data.activities && data.activities.length ? `<div class="card"><h2>${SVG.target} Activities</h2><div class="tags">${data.activities.map(a=>`<span class="tag">${a}</span>`).join('')}</div></div>` : ''}
                    ${data.ada_text ? `<div class="card"><h2>${SVG.accessible} Accessibility</h2><p>${data.ada_text}</p></div>` : ''}
                    ${summary ? `<div class="card condition-card">
                        <h2>${SVG.binoculars} Condition Summary</h2>
                        <p><strong>Based on ${summary.report_count} recent report(s)</strong></p>
                        <div class="condition-grid">
                            <div>Status: <span class="badge badge-${statusClass}">${statusLabel}</span></div>
                            <div>Trail: <strong>${summary.trail_condition}</strong></div>
                            <div>Road Access: <strong>${(summary.road_access||'unknown').replace('_',' ')}</strong></div>
                            <div>Trash: <strong>${summary.trash_level}</strong></div>
                            <div>Last reported: ${new Date(summary.last_reported).toLocaleDateString()}</div>
                        </div>
                    </div>` : ''}
                    <div class="card" id="weather-inference-card" style="display:none;">
                        <h2>${SVG.thermometer} Weather-Inferred Conditions</h2>
                        <div id="weather-inference"></div>
                    </div>
                    <div class="card">
                        <h2>${SVG.edit} Submit a Condition Report</h2>
                        <form id="report-form" onsubmit="submitReport(event)">
                            <div class="form-row">
                                <label>Status</label>
                                <select name="status" required>
                                    <option value="open">${SVG.checkCircle} Open</option>
                                    <option value="partially_open">${SVG.alertTriangle} Partially Open</option>
                                    <option value="closed">${SVG.xCircle} Closed</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label>Trail Condition</label>
                                <select name="trail_condition">
                                    <option value="">-- Select --</option>
                                    <option value="dry">Dry</option>
                                    <option value="muddy">Muddy</option>
                                    <option value="snowy">Snowy</option>
                                    <option value="icy">Icy</option>
                                    <option value="overgrown">Overgrown</option>
                                    <option value="flooded">Flooded</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label>Trash Level</label>
                                <select name="trash_level">
                                    <option value="">-- Select --</option>
                                    <option value="clean">Clean</option>
                                    <option value="some_litter">Some Litter</option>
                                    <option value="lots_of_trash">Lots of Trash</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label>Road Access</label>
                                <select name="road_access">
                                    <option value="">-- Select --</option>
                                    <option value="clear_paved">Roads clear and paved</option>
                                    <option value="passable_rough">Roads passable but rough</option>
                                    <option value="muddy_snowy">Roads muddy/snowy â€” high clearance recommended</option>
                                    <option value="closed">Roads closed/impassable</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label>Accessibility Notes</label>
                                <textarea name="accessibility_notes" rows="2" placeholder="Wheelchair access, trail width, etc."></textarea>
                            </div>
                            <div class="form-row">
                                <label>General Notes</label>
                                <textarea name="general_notes" rows="3" placeholder="What did you see? How was it?"></textarea>
                            </div>
                            <div class="form-row">
                                <label>Date Visited</label>
                                <input type="date" name="date_visited">
                            </div>
                            <div class="form-row">
                                <label>Photo URL (optional)</label>
                                <input type="url" name="photo_url" placeholder="https://...">
                            </div>
                            <button type="submit" class="btn-primary">Submit Report</button>
                        </form>
                    </div>
                    <div class="card">
                        <h2>${SVG.chat} Community Reports</h2>
                        <div id="reports-list">Loading reports...</div>
                    </div>
                </div>
                <div class="facility-sidebar">
                    <div class="card">
                        <h2>${SVG.mapPin} Location</h2>
                        <div id="detail-map" style="height:250px;border-radius:8px;"></div>
                    </div>
                    <div class="card">
                        <h2>${SVG.sun} Current Weather</h2>
                        <div id="weather-widget">Loading...</div>
                    </div>
                    ${data.phone ? `<div class="card"><h2>${SVG.phone} Contact</h2><p>${data.phone}</p>${data.email?`<p>${data.email}</p>`:''}</div>` : ''}
                    ${data.reservation_url ? `<div class="card"><a href="${data.reservation_url}" target="_blank" class="btn-primary" style="display:block;text-align:center;">Make Reservation</a></div>` : ''}
                </div>
            </div>
        `;
        
        if (data.lat && data.lon) {
            const map = initMap('detail-map', data.lat, data.lon, 12);
            L.marker([data.lat, data.lon]).addTo(map).bindPopup(data.name);
            loadWeather(data.lat, data.lon);
            loadWeatherInference(data.lat, data.lon);
        }
        
        loadReports(facilityId);
    } catch(e) {
        page.innerHTML = `<p class="error">Failed to load facility: ${e.message}</p>`;
    }
}

async function loadWeather(lat, lon) {
    try {
        const res = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
        const data = await res.json();
        const w = data.current_weather;
        if (!w) { document.getElementById('weather-widget').textContent = 'Unavailable'; return; }
        const weatherDesc = {
            0: [SVG.sun, 'Clear'],
            1: [SVG.sun, 'Mostly Clear'],
            2: [SVG.cloud, 'Partly Cloudy'],
            3: [SVG.cloud, 'Overcast'],
            45: [SVG.cloud, 'Fog'],
            51: [SVG.cloud, 'Drizzle'],
            61: [SVG.cloud, 'Rain'],
            71: [SVG.snowflake, 'Snow'],
            95: [SVG.cloud, 'Thunderstorm']
        };
        const [icon, label] = weatherDesc[w.weathercode] || [SVG.cloud, `Code ${w.weathercode}`];
        document.getElementById('weather-widget').innerHTML = `
            <div class="weather-info">
                <div class="weather-temp">${Math.round(w.temperature)}\u00b0F</div>
                <div>${icon} ${label}</div>
                <div>Wind: ${Math.round(w.windspeed)} mph</div>
            </div>
        `;
    } catch(e) {
        document.getElementById('weather-widget').textContent = 'Unavailable';
    }
}

async function loadWeatherInference(lat, lon) {
    try {
        const res = await fetch(`/api/weather/history?lat=${lat}&lon=${lon}`);
        const data = await res.json();
        if (data.error || !data.inference) return;
        const inf = data.inference;
        const card = document.getElementById('weather-inference-card');
        const container = document.getElementById('weather-inference');
        card.style.display = 'block';

        const levelClass = { green: 'good', yellow: 'caution', red: 'bad' }[inf.level] || 'unknown';
        const levelIcon = { green: SVG.checkCircle, yellow: SVG.alertTriangle, red: SVG.xCircle }[inf.level] || '';

        container.innerHTML = `
            <div class="inference-banner inference-${inf.level}">
                <span class="inference-icon">${levelIcon}</span>
                <span class="inference-prediction">${inf.prediction}</span>
            </div>
            <div class="inference-details">
                <div class="inference-stats">
                    <div class="inference-stat">
                        <span class="inference-stat-value">${inf.total_snow_inches}"</span>
                        <span class="inference-stat-label">${SVG.snowflake} Snow (7d)</span>
                    </div>
                    <div class="inference-stat">
                        <span class="inference-stat-value">${inf.total_rain_inches}"</span>
                        <span class="inference-stat-label">${SVG.cloud} Rain (7d)</span>
                    </div>
                    <div class="inference-stat">
                        <span class="inference-stat-value">${inf.avg_high}\u00b0</span>
                        <span class="inference-stat-label">${SVG.thermometer} Avg High</span>
                    </div>
                    <div class="inference-stat">
                        <span class="inference-stat-value">${inf.avg_low}\u00b0</span>
                        <span class="inference-stat-label">${SVG.thermometer} Avg Low</span>
                    </div>
                </div>
                ${inf.reasons.length ? `<ul class="inference-reasons">${inf.reasons.map(r => `<li>${r}</li>`).join('')}</ul>` : ''}
                <p class="inference-disclaimer">Based on 7-day weather history from Open-Meteo. Actual conditions may vary.</p>
            </div>
        `;
    } catch(e) {
        // silently fail
    }
}

loadFacility();
</script>
{% endblock %}
