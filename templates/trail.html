{% extends "base.html" %}
{% block title %}Trail Details — Trail Condish{% endblock %}
{% block content %}
<div class="container trail-page" id="trailContent">
    <div class="loading-spinner"><div class="spinner"></div><p>Loading trail info...</p></div>
</div>
{% endblock %}
{% block scripts %}
<script>
const OSM_TYPE = '{{ osm_type }}';
const OSM_ID = '{{ osm_id }}';
const FID = `${OSM_TYPE}/${OSM_ID}`;
const REPORT_KEY = `${OSM_TYPE}:${OSM_ID}`;
const weatherDescriptions = {0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Foggy',48:'Rime fog',51:'Light drizzle',53:'Drizzle',55:'Heavy drizzle',61:'Light rain',63:'Rain',65:'Heavy rain',66:'Freezing rain',67:'Heavy freezing rain',71:'Light snow',73:'Snow',75:'Heavy snow',77:'Snow grains',80:'Light showers',81:'Showers',82:'Heavy showers',85:'Snow showers',86:'Heavy snow showers',95:'Thunderstorm',96:'Thunderstorm w/ hail',99:'Severe thunderstorm'};

function weatherIcon(code) {
    if (code === 0 || code === 1) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#e9c46a" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
    if (code === 2) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#b08968" stroke-width="2"><circle cx="8" cy="10" r="4" stroke="#e9c46a"/><line x1="8" y1="4" x2="8" y2="5" stroke="#e9c46a"/><line x1="3" y1="10" x2="4" y2="10" stroke="#e9c46a"/><path d="M18 10h-1.26A5 5 0 0 0 12 6a4.97 4.97 0 0 0-3 1"/><path d="M18 10a3 3 0 1 1 0 6H10"/></svg>';
    if (code === 3) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z"/></svg>';
    if (code >= 45 && code <= 48) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z"/><line x1="4" y1="16" x2="8" y2="16" opacity=".5"/><line x1="10" y1="16" x2="14" y2="16" opacity=".5"/></svg>';
    if (code >= 51 && code <= 55) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#4a90d9" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z" stroke="#888"/><line x1="8" y1="22" x2="8" y2="20"/><line x1="12" y1="22" x2="12" y2="20"/></svg>';
    if (code >= 61 && code <= 67) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#4a90d9" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z" stroke="#888"/><line x1="7" y1="22" x2="7" y2="18"/><line x1="11" y1="22" x2="11" y2="18"/><line x1="15" y1="22" x2="15" y2="18"/></svg>';
    if (code >= 71 && code <= 77) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#7b9ec4" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z" stroke="#888"/><circle cx="8" cy="21" r="1" fill="#7b9ec4"/><circle cx="12" cy="19" r="1" fill="#7b9ec4"/><circle cx="16" cy="21" r="1" fill="#7b9ec4"/></svg>';
    if (code >= 80 && code <= 82) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#4a90d9" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z" stroke="#555"/><line x1="7" y1="22" x2="8" y2="18"/><line x1="11" y1="22" x2="12" y2="18"/><line x1="15" y1="22" x2="16" y2="18"/></svg>';
    if (code >= 85 && code <= 86) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#7b9ec4" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z" stroke="#555"/><circle cx="8" cy="20" r="1" fill="#7b9ec4"/><circle cx="12" cy="22" r="1" fill="#7b9ec4"/><circle cx="16" cy="20" r="1" fill="#7b9ec4"/></svg>';
    if (code >= 95) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z"/><polyline points="13 16 11 20 15 20 13 24" stroke="#e9c46a" stroke-width="2"/></svg>';
    return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><circle cx="12" cy="12" r="5"/></svg>';
}

function difficultyLabel(sac) {
    const m = {'hiking':'Easy','mountain_hiking':'Moderate','demanding_mountain_hiking':'Hard','alpine_hiking':'Expert','demanding_alpine_hiking':'Expert+','difficult_alpine_hiking':'Extreme'};
    return m[sac] || '';
}

async function loadTrail() {
    const [trailRes, reportsRes] = await Promise.all([
        fetch(`/api/trail/${FID}`),
        fetch(`/api/trail/${REPORT_KEY}/reports`)
    ]);
    const trail = await trailRes.json();
    const reports = await reportsRes.json();
    if (trail.error) { document.getElementById('trailContent').innerHTML = `<p>Trail not found: ${trail.error}</p>`; return; }
    
    const diff = difficultyLabel(trail.difficulty);
    const distKm = trail.distance_km || trail.distance_tag;
    const distMi = trail.distance_km ? (trail.distance_km * 0.621371).toFixed(1) : null;
    
    let html = `<a href="javascript:void(0)" onclick="history.back()" class="back-link">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
        Back to Search
    </a>`;
    html += `<h1>${trail.name}</h1>`;
    
    // Trail info
    const surfaceLabel = trail.surface ? trail.surface.charAt(0).toUpperCase() + trail.surface.slice(1) : '';
    const typeMap = {'ground':'Dirt','dirt':'Dirt','earth':'Dirt','gravel':'Gravel','paved':'Paved','asphalt':'Paved','concrete':'Paved','compacted':'Compacted','fine_gravel':'Gravel','wood':'Boardwalk','grass':'Grass','sand':'Sand','rock':'Rock','paving_stones':'Paved'};
    const trailType = trail.surface ? (typeMap[trail.surface.toLowerCase()] || surfaceLabel) : '';
    
    html += `<div class="trail-details-grid">`;
    if (trailType) html += `<div class="trail-detail-item"><span class="detail-label">Trail Type</span><span class="detail-value">${trailType}</span></div>`;
    if (diff) html += `<div class="trail-detail-item"><span class="detail-label">Difficulty</span><span class="detail-value">${diff}</span></div>`;
    if (distMi) html += `<div class="trail-detail-item"><span class="detail-label">Length</span><span class="detail-value">${distMi} mi (${trail.distance_km} km)</span></div>`;
    else if (distKm) html += `<div class="trail-detail-item"><span class="detail-label">Length</span><span class="detail-value">${distKm}</span></div>`;
    if (trail.access) html += `<div class="trail-detail-item"><span class="detail-label">Access</span><span class="detail-value">${trail.access}</span></div>`;
    if (trail.wheelchair) html += `<div class="trail-detail-item"><span class="detail-label">Wheelchair</span><span class="detail-value">${trail.wheelchair}</span></div>`;
    if (trail.network) html += `<div class="trail-detail-item"><span class="detail-label">Network</span><span class="detail-value">${trail.network}</span></div>`;
    html += `</div>`;
    
    if (trail.desc) html += `<p class="trail-desc">${trail.desc}</p>`;
    if (trail.operator) html += `<p class="trail-operator">Managed by: ${trail.operator}</p>`;
    if (trail.website) html += `<p><a href="${trail.website}" target="_blank" rel="noopener">Official Website</a></p>`;
    
    // === CONDITIONS SECTION (TOP) — Two columns ===
    html += `<div class="conditions-dual">`;
    
    // Left: Weather-based conditions
    html += `<div class="condition-panel" id="weatherConditions">
        <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
            Trail Conditions Based On Weather
        </h2>
        <p class="muted">Loading weather data...</p>
    </div>`;
    
    // Right: Community-based conditions
    html += `<div class="condition-panel" id="communityConditions">
        <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Trail Conditions Based On Community
        </h2>
        <div id="reportsList">${renderReports(reports)}</div>
    </div>`;
    
    html += `</div>`;
    
    // === SUBMIT REPORT ===
    html += `<div class="section-block">
        <h2>Submit a Condition Report</h2>
        <form id="reportForm" class="report-form">
            <div class="form-row">
                <label>Overall Condition<select name="trail_condition"><option>Great</option><option>Good</option><option>Fair</option><option>Poor</option></select></label>
                <label>Trail Surface<select name="trail_surface"><option>Dry</option><option>Muddy</option><option>Snowy</option><option>Icy</option></select></label>
                <label>Road Access<select name="road_access"><option>Open</option><option>Rough</option><option>Closed</option></select></label>
            </div>
            <label>Notes<textarea name="general_notes" rows="2" placeholder="What did you see out there?"></textarea></label>
            <label>Date Visited<input type="date" name="date_visited" value="${new Date().toISOString().slice(0,10)}"></label>
            <button type="submit" class="btn btn-primary">Submit Report</button>
        </form>
    </div>`;
    
    // === MAP (BOTTOM) ===
    if (trail.lat && trail.lon) {
        html += `<div class="section-block">
            <h2>Trail Map</h2>
            <div id="trailMap" class="trail-map"></div>
            <label class="toggle-label"><input type="checkbox" id="overlayToggle" checked> Show hiking trails overlay</label>
        </div>`;
    }
    
    // === ELEVATION PROFILE (below map) ===
    if (trail.geometry && trail.geometry.length > 2) {
        html += `<div class="section-block" id="elevationSection">
            <h2>Elevation Profile</h2>
            <p class="muted">Loading elevation data...</p>
        </div>`;
    }
    
    // OSM attribution
    html += `<p class="muted" style="margin-top:2rem;font-size:0.8rem">Trail data from <a href="https://www.openstreetmap.org/${OSM_TYPE}/${OSM_ID}" target="_blank">OpenStreetMap</a></p>`;
    
    document.getElementById('trailContent').innerHTML = html;
    
    // Init map
    if (trail.lat && trail.lon) {
        const map = L.map('trailMap').setView([trail.lat, trail.lon], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {attribution:'&copy; OSM &copy; CARTO', subdomains:'abcd', maxZoom:20}).addTo(map);
        
        if (trail.geometry && trail.geometry.length > 1) {
            const latlngs = trail.geometry.map(p => [p.lat, p.lon]);
            const polyline = L.polyline(latlngs, {color: '#c44536', weight: 4, opacity: 0.8}).addTo(map);
            map.fitBounds(polyline.getBounds(), {padding: [30, 30]});
        } else {
            L.marker([trail.lat, trail.lon]).addTo(map).bindPopup(trail.name).openPopup();
        }
        
        const hikingOverlay = L.tileLayer('https://tile.waymarkedtrails.org/hiking/{z}/{x}/{y}.png', {opacity: 0.7, attribution:'Waymarked Trails'});
        hikingOverlay.addTo(map);
        document.getElementById('overlayToggle').addEventListener('change', function() {
            this.checked ? hikingOverlay.addTo(map) : map.removeLayer(hikingOverlay);
        });
    }
    
    // Load elevation profile
    if (trail.geometry && trail.geometry.length > 2) {
        // Sample points (max 100 for API)
        const pts = trail.geometry;
        const step = Math.max(1, Math.floor(pts.length / 100));
        const sampled = pts.filter((_, i) => i % step === 0);
        if (sampled[sampled.length - 1] !== pts[pts.length - 1]) sampled.push(pts[pts.length - 1]);
        
        const lats = sampled.map(p => p.lat.toFixed(5)).join(',');
        const lons = sampled.map(p => p.lon.toFixed(5)).join(',');
        
        try {
            const eRes = await fetch(`/api/elevation?lats=${lats}&lons=${lons}`);
            const eData = await eRes.json();
            if (eData.elevation && eData.elevation.length) {
                const elev = eData.elevation;
                const minE = Math.min(...elev);
                const maxE = Math.max(...elev);
                const gainM = elev.reduce((acc, v, i) => i > 0 && v > elev[i-1] ? acc + (v - elev[i-1]) : acc, 0);
                const minFt = Math.round(minE * 3.281);
                const maxFt = Math.round(maxE * 3.281);
                const gainFt = Math.round(gainM * 3.281);
                
                let ehtml = `<div class="elev-stats">
                    <div class="elev-stat"><span class="detail-label">Min Elevation</span><span class="detail-value">${minFt} ft</span></div>
                    <div class="elev-stat"><span class="detail-label">Max Elevation</span><span class="detail-value">${maxFt} ft</span></div>
                    <div class="elev-stat"><span class="detail-label">Elevation Gain</span><span class="detail-value">${gainFt} ft</span></div>
                </div>
                <canvas id="elevChart" width="800" height="200" class="elev-chart"></canvas>`;
                document.getElementById('elevationSection').innerHTML = `<h2>Elevation Profile</h2>${ehtml}`;
                
                // Draw chart
                const canvas = document.getElementById('elevChart');
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                const pad = {top: 10, right: 10, bottom: 25, left: 50};
                const cw = w - pad.left - pad.right;
                const ch = h - pad.top - pad.bottom;
                const range = maxE - minE || 1;
                
                // Background
                ctx.fillStyle = '#fdfbf7';
                ctx.fillRect(0, 0, w, h);
                
                // Grid lines
                ctx.strokeStyle = '#e8e0d4';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    const y = pad.top + (ch / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(pad.left, y);
                    ctx.lineTo(w - pad.right, y);
                    ctx.stroke();
                    
                    const elevVal = Math.round((maxE - (range / 4) * i) * 3.281);
                    ctx.fillStyle = '#b08968';
                    ctx.font = '11px Nunito, sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(`${elevVal}ft`, pad.left - 5, y + 4);
                }
                
                // Fill area
                ctx.beginPath();
                ctx.moveTo(pad.left, pad.top + ch);
                for (let i = 0; i < elev.length; i++) {
                    const x = pad.left + (i / (elev.length - 1)) * cw;
                    const y = pad.top + ch - ((elev[i] - minE) / range) * ch;
                    ctx.lineTo(x, y);
                }
                ctx.lineTo(pad.left + cw, pad.top + ch);
                ctx.closePath();
                ctx.fillStyle = 'rgba(45, 106, 79, 0.15)';
                ctx.fill();
                
                // Line
                ctx.beginPath();
                for (let i = 0; i < elev.length; i++) {
                    const x = pad.left + (i / (elev.length - 1)) * cw;
                    const y = pad.top + ch - ((elev[i] - minE) / range) * ch;
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.strokeStyle = '#2d6a4f';
                ctx.lineWidth = 2.5;
                ctx.stroke();
            }
        } catch(e) {
            document.getElementById('elevationSection').innerHTML = '<h2>Elevation Profile</h2><p class="muted">Could not load elevation data</p>';
        }
    }
    
    // Load weather conditions
    if (trail.lat && trail.lon) {
        const wr = await fetch(`/api/weather/history?lat=${trail.lat}&lon=${trail.lon}`);
        const w = await wr.json();
        if (!w.error) {
            let whtml = '';
            const tempF = Math.round(w.current.temp_c * 9/5 + 32);
            const wDesc = weatherDescriptions[w.current.weathercode] || 'Unknown';
            
            // Current weather
            whtml += `<div class="weather-current"><span class="weather-temp">${tempF}°F</span> <span class="weather-desc">${wDesc}</span></div>`;
            whtml += `<div class="weather-wind">Wind: ${w.current.windspeed} km/h</div>`;
            
            // Condition badge
            const inf = w.inference;
            whtml += `<div class="condition-badge" style="background:${inf.color}">${inf.condition.toUpperCase()}</div>`;
            
            // Reasoning
            whtml += `<div class="condition-reasons">`;
            inf.reasons.forEach(r => { whtml += `<p class="reason">${r}</p>`; });
            whtml += `</div>`;
            
            // 7-day history
            whtml += `<div class="weather-history"><h3>7-Day History</h3><div class="history-grid">`;
            const codes = w.daily.codes || [];
            for (let i = 0; i < (w.daily.dates||[]).length; i++) {
                const d = w.daily.dates[i];
                const hi = w.daily.temp_max[i] != null ? Math.round(w.daily.temp_max[i]*9/5+32) : '--';
                const lo = w.daily.temp_min[i] != null ? Math.round(w.daily.temp_min[i]*9/5+32) : '--';
                const precip = w.daily.precip[i] || 0;
                const snow = w.daily.snow[i] || 0;
                const code = codes[i] != null ? codes[i] : 0;
                whtml += `<div class="history-day">${weatherIcon(code)}<div class="hd-date">${d.slice(5)}</div><div class="hd-temp">${hi}/${lo}°F</div>${precip > 0 ? `<div class="hd-precip">${precip}mm rain</div>` : ''}${snow > 0 ? `<div class="hd-snow">${snow}cm snow</div>` : ''}</div>`;
            }
            whtml += `</div></div>`;
            
            document.getElementById('weatherConditions').innerHTML = `<h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                Trail Conditions Based On Weather</h2>${whtml}`;
        }
    }
    
    // Report form handler
    document.getElementById('reportForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const fd = new FormData(this);
        const data = Object.fromEntries(fd);
        await fetch(`/api/trail/${REPORT_KEY}/reports`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
        this.reset();
        const rr = await fetch(`/api/trail/${REPORT_KEY}/reports`);
        document.getElementById('reportsList').innerHTML = renderReports(await rr.json());
    });
}

function renderReports(reports) {
    if (!reports || !reports.length) return '<p class="muted">No Reports Made</p>';
    
    // Synthesize community condition from latest reports
    const latest = reports[0];
    let synthesis = `<div class="community-synthesis">
        <div class="condition-badge" style="background:${conditionColor(latest.trail_condition)}">${(latest.trail_condition || 'Unknown').toUpperCase()}</div>
        ${latest.trail_surface ? `<span class="tag">${latest.trail_surface}</span>` : ''}
        ${latest.road_access ? `<span class="tag">Road: ${latest.road_access}</span>` : ''}
        <p class="muted" style="margin-top:0.5rem">Based on ${reports.length} report${reports.length !== 1 ? 's' : ''}</p>
    </div>`;
    
    synthesis += `<div class="reports-list">`;
    synthesis += reports.map(r => `<div class="report">
        <div class="report-header">
            <span class="report-condition tag" style="background:${conditionColor(r.trail_condition)};color:white">${r.trail_condition || ''}</span>
            ${r.trail_surface ? `<span class="tag">${r.trail_surface}</span>` : ''}
            ${r.road_access ? `<span class="tag">Road: ${r.road_access}</span>` : ''}
            <span class="report-date">${r.date_visited || r.created_at?.slice(0,10) || ''}</span>
        </div>
        ${r.general_notes ? `<p class="report-notes">${r.general_notes}</p>` : ''}
        <div class="report-votes">
            <button onclick="vote(${r.id},'up')" class="vote-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5m-7 7l7-7 7 7"/></svg>
                ${r.upvotes||0}
            </button>
            <button onclick="vote(${r.id},'down')" class="vote-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14m7-7l-7 7-7-7"/></svg>
                ${r.downvotes||0}
            </button>
        </div>
    </div>`).join('');
    synthesis += `</div>`;
    return synthesis;
}

function conditionColor(cond) {
    if (!cond) return '#6c757d';
    const c = cond.toLowerCase();
    if (c === 'great') return '#2d6a4f';
    if (c === 'good') return '#52b788';
    if (c === 'fair') return '#e9c46a';
    if (c === 'poor') return '#c44536';
    return '#6c757d';
}

async function vote(id, type) {
    await fetch(`/api/reports/${id}/vote`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({vote_type: type})});
    const rr = await fetch(`/api/trail/${REPORT_KEY}/reports`);
    document.getElementById('reportsList').innerHTML = renderReports(await rr.json());
}

loadTrail();
</script>
{% endblock %}
