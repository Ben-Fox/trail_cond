{% extends "base.html" %}
{% block title %}Trail Details — Trail Condish{% endblock %}
{% block content %}
<div class="container trail-page" id="trailContent">
    <div class="loading-spinner"><div class="spinner"></div><p>Loading trail info...</p></div>
</div>
{% endblock %}
{% block scripts %}
<script>
const OSM_TYPE = '{{ osm_type }}';
const OSM_ID = '{{ osm_id }}';
const FID = `${OSM_TYPE}/${OSM_ID}`;
const REPORT_KEY = `${OSM_TYPE}:${OSM_ID}`;
const weatherDescriptions = {0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Foggy',48:'Rime fog',51:'Light drizzle',53:'Drizzle',55:'Heavy drizzle',61:'Light rain',63:'Rain',65:'Heavy rain',66:'Freezing rain',67:'Heavy freezing rain',71:'Light snow',73:'Snow',75:'Heavy snow',77:'Snow grains',80:'Light showers',81:'Showers',82:'Heavy showers',85:'Snow showers',86:'Heavy snow showers',95:'Thunderstorm',96:'Thunderstorm w/ hail',99:'Severe thunderstorm'};

function difficultyLabel(sac) {
    const m = {'hiking':'Easy','mountain_hiking':'Moderate','demanding_mountain_hiking':'Hard','alpine_hiking':'Expert','demanding_alpine_hiking':'Expert+','difficult_alpine_hiking':'Extreme'};
    return m[sac] || '';
}

async function loadTrail() {
    const [trailRes, reportsRes] = await Promise.all([
        fetch(`/api/trail/${FID}`),
        fetch(`/api/trail/${REPORT_KEY}/reports`)
    ]);
    const trail = await trailRes.json();
    const reports = await reportsRes.json();
    if (trail.error) { document.getElementById('trailContent').innerHTML = `<p>Trail not found: ${trail.error}</p>`; return; }
    
    const diff = difficultyLabel(trail.difficulty);
    const distKm = trail.distance_km || trail.distance_tag;
    const distMi = trail.distance_km ? (trail.distance_km * 0.621371).toFixed(1) : null;
    
    let html = `<h1>${trail.name}</h1>`;
    
    // Tags row
    html += `<div class="trail-tags">`;
    if (diff) html += `<span class="tag tag-diff">${diff}</span>`;
    if (trail.surface) html += `<span class="tag">${trail.surface}</span>`;
    if (distMi) html += `<span class="tag">${distMi} mi (${trail.distance_km} km)</span>`;
    else if (distKm) html += `<span class="tag">${distKm}</span>`;
    if (trail.access) html += `<span class="tag">Access: ${trail.access}</span>`;
    if (trail.wheelchair) html += `<span class="tag">Wheelchair: ${trail.wheelchair}</span>`;
    if (trail.network) html += `<span class="tag">${trail.network}</span>`;
    html += `</div>`;
    
    if (trail.desc) html += `<p class="trail-desc">${trail.desc}</p>`;
    if (trail.operator) html += `<p class="trail-operator">Managed by: ${trail.operator}</p>`;
    if (trail.website) html += `<p><a href="${trail.website}" target="_blank" rel="noopener">Official Website</a></p>`;
    
    // === CONDITIONS SECTION (TOP) — Two columns ===
    html += `<div class="conditions-dual">`;
    
    // Left: Weather-based conditions
    html += `<div class="condition-panel" id="weatherConditions">
        <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
            Trail Conditions Based On Weather
        </h2>
        <p class="muted">Loading weather data...</p>
    </div>`;
    
    // Right: Community-based conditions
    html += `<div class="condition-panel" id="communityConditions">
        <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Trail Conditions Based On Community
        </h2>
        <div id="reportsList">${renderReports(reports)}</div>
    </div>`;
    
    html += `</div>`;
    
    // === SUBMIT REPORT ===
    html += `<div class="section-block">
        <h2>Submit a Condition Report</h2>
        <form id="reportForm" class="report-form">
            <div class="form-row">
                <label>Overall Condition<select name="trail_condition"><option>Great</option><option>Good</option><option>Fair</option><option>Poor</option></select></label>
                <label>Trail Surface<select name="trail_surface"><option>Dry</option><option>Muddy</option><option>Snowy</option><option>Icy</option></select></label>
                <label>Road Access<select name="road_access"><option>Open</option><option>Rough</option><option>Closed</option></select></label>
            </div>
            <label>Notes<textarea name="general_notes" rows="2" placeholder="What did you see out there?"></textarea></label>
            <label>Date Visited<input type="date" name="date_visited" value="${new Date().toISOString().slice(0,10)}"></label>
            <button type="submit" class="btn btn-primary">Submit Report</button>
        </form>
    </div>`;
    
    // === MAP (BOTTOM) ===
    if (trail.lat && trail.lon) {
        html += `<div class="section-block">
            <h2>Trail Map</h2>
            <div id="trailMap" class="trail-map"></div>
            <label class="toggle-label"><input type="checkbox" id="overlayToggle" checked> Show hiking trails overlay</label>
        </div>`;
    }
    
    // OSM attribution
    html += `<p class="muted" style="margin-top:2rem;font-size:0.8rem">Trail data from <a href="https://www.openstreetmap.org/${OSM_TYPE}/${OSM_ID}" target="_blank">OpenStreetMap</a></p>`;
    
    document.getElementById('trailContent').innerHTML = html;
    
    // Init map
    if (trail.lat && trail.lon) {
        const map = L.map('trailMap').setView([trail.lat, trail.lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'&copy; OSM'}).addTo(map);
        
        if (trail.geometry && trail.geometry.length > 1) {
            const latlngs = trail.geometry.map(p => [p.lat, p.lon]);
            const polyline = L.polyline(latlngs, {color: '#c44536', weight: 4, opacity: 0.8}).addTo(map);
            map.fitBounds(polyline.getBounds(), {padding: [30, 30]});
        } else {
            L.marker([trail.lat, trail.lon]).addTo(map).bindPopup(trail.name).openPopup();
        }
        
        const hikingOverlay = L.tileLayer('https://tile.waymarkedtrails.org/hiking/{z}/{x}/{y}.png', {opacity: 0.7, attribution:'Waymarked Trails'});
        hikingOverlay.addTo(map);
        document.getElementById('overlayToggle').addEventListener('change', function() {
            this.checked ? hikingOverlay.addTo(map) : map.removeLayer(hikingOverlay);
        });
    }
    
    // Load weather conditions
    if (trail.lat && trail.lon) {
        const wr = await fetch(`/api/weather/history?lat=${trail.lat}&lon=${trail.lon}`);
        const w = await wr.json();
        if (!w.error) {
            let whtml = '';
            const tempF = Math.round(w.current.temp_c * 9/5 + 32);
            const wDesc = weatherDescriptions[w.current.weathercode] || 'Unknown';
            
            // Current weather
            whtml += `<div class="weather-current"><span class="weather-temp">${tempF}°F</span> <span class="weather-desc">${wDesc}</span></div>`;
            whtml += `<div class="weather-wind">Wind: ${w.current.windspeed} km/h</div>`;
            
            // Condition badge
            const inf = w.inference;
            whtml += `<div class="condition-badge" style="background:${inf.color}">${inf.condition.toUpperCase()}</div>`;
            
            // Reasoning
            whtml += `<div class="condition-reasons">`;
            inf.reasons.forEach(r => { whtml += `<p class="reason">${r}</p>`; });
            whtml += `</div>`;
            
            // 7-day history
            whtml += `<div class="weather-history"><h3>7-Day History</h3><div class="history-grid">`;
            for (let i = 0; i < (w.daily.dates||[]).length; i++) {
                const d = w.daily.dates[i];
                const hi = w.daily.temp_max[i] != null ? Math.round(w.daily.temp_max[i]*9/5+32) : '--';
                const lo = w.daily.temp_min[i] != null ? Math.round(w.daily.temp_min[i]*9/5+32) : '--';
                const precip = w.daily.precip[i] || 0;
                const snow = w.daily.snow[i] || 0;
                whtml += `<div class="history-day"><div class="hd-date">${d.slice(5)}</div><div class="hd-temp">${hi}/${lo}°F</div>${precip > 0 ? `<div class="hd-precip">${precip}mm rain</div>` : ''}${snow > 0 ? `<div class="hd-snow">${snow}cm snow</div>` : ''}</div>`;
            }
            whtml += `</div></div>`;
            
            document.getElementById('weatherConditions').innerHTML = `<h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                Trail Conditions Based On Weather</h2>${whtml}`;
        }
    }
    
    // Report form handler
    document.getElementById('reportForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const fd = new FormData(this);
        const data = Object.fromEntries(fd);
        await fetch(`/api/trail/${REPORT_KEY}/reports`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
        this.reset();
        const rr = await fetch(`/api/trail/${REPORT_KEY}/reports`);
        document.getElementById('reportsList').innerHTML = renderReports(await rr.json());
    });
}

function renderReports(reports) {
    if (!reports || !reports.length) return '<p class="muted">No Reports Made</p>';
    
    // Synthesize community condition from latest reports
    const latest = reports[0];
    let synthesis = `<div class="community-synthesis">
        <div class="condition-badge" style="background:${conditionColor(latest.trail_condition)}">${(latest.trail_condition || 'Unknown').toUpperCase()}</div>
        ${latest.trail_surface ? `<span class="tag">${latest.trail_surface}</span>` : ''}
        ${latest.road_access ? `<span class="tag">Road: ${latest.road_access}</span>` : ''}
        <p class="muted" style="margin-top:0.5rem">Based on ${reports.length} report${reports.length !== 1 ? 's' : ''}</p>
    </div>`;
    
    synthesis += `<div class="reports-list">`;
    synthesis += reports.map(r => `<div class="report">
        <div class="report-header">
            <span class="report-condition tag" style="background:${conditionColor(r.trail_condition)};color:white">${r.trail_condition || ''}</span>
            ${r.trail_surface ? `<span class="tag">${r.trail_surface}</span>` : ''}
            ${r.road_access ? `<span class="tag">Road: ${r.road_access}</span>` : ''}
            <span class="report-date">${r.date_visited || r.created_at?.slice(0,10) || ''}</span>
        </div>
        ${r.general_notes ? `<p class="report-notes">${r.general_notes}</p>` : ''}
        <div class="report-votes">
            <button onclick="vote(${r.id},'up')" class="vote-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5m-7 7l7-7 7 7"/></svg>
                ${r.upvotes||0}
            </button>
            <button onclick="vote(${r.id},'down')" class="vote-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14m7-7l-7 7-7-7"/></svg>
                ${r.downvotes||0}
            </button>
        </div>
    </div>`).join('');
    synthesis += `</div>`;
    return synthesis;
}

function conditionColor(cond) {
    if (!cond) return '#6c757d';
    const c = cond.toLowerCase();
    if (c === 'great') return '#2d6a4f';
    if (c === 'good') return '#52b788';
    if (c === 'fair') return '#e9c46a';
    if (c === 'poor') return '#c44536';
    return '#6c757d';
}

async function vote(id, type) {
    await fetch(`/api/reports/${id}/vote`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({vote_type: type})});
    const rr = await fetch(`/api/trail/${REPORT_KEY}/reports`);
    document.getElementById('reportsList').innerHTML = renderReports(await rr.json());
}

loadTrail();
</script>
{% endblock %}
