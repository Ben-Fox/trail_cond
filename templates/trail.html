{% extends "base.html" %}
{% block title %}Trail Details — Trail Condish{% endblock %}
{% block content %}
<div class="container trail-page" id="trailContent">
    <div class="loading-spinner"><div class="spinner"></div><p>Loading trail info...</p></div>
</div>
{% endblock %}
{% block scripts %}
<script>
const CHEVRON_SVG = '<svg class="chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';

function initCollapsible(panelId) {
    const panel = document.getElementById(panelId);
    if (!panel) return;
    const h2 = panel.querySelector('h2');
    if (!h2 || h2.querySelector('.chevron')) return;
    h2.insertAdjacentHTML('beforeend', CHEVRON_SVG);
    h2.addEventListener('click', function() {
        panel.classList.toggle('collapsed');
    });
    // Start collapsed
    panel.classList.add('collapsed');
}

const OSM_TYPE = '{{ osm_type }}';
const OSM_ID = '{{ osm_id }}';
const FID = `${OSM_TYPE}/${OSM_ID}`;
const REPORT_KEY = `${OSM_TYPE}:${OSM_ID}`;
const weatherDescriptions = {0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Foggy',48:'Rime fog',51:'Light drizzle',53:'Drizzle',55:'Heavy drizzle',61:'Light rain',63:'Rain',65:'Heavy rain',66:'Freezing rain',67:'Heavy freezing rain',71:'Light snow',73:'Snow',75:'Heavy snow',77:'Snow grains',80:'Light showers',81:'Showers',82:'Heavy showers',85:'Snow showers',86:'Heavy snow showers',95:'Thunderstorm',96:'Thunderstorm w/ hail',99:'Severe thunderstorm'};

function weatherIcon(code) {
    if (code === 0 || code === 1) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#e9c46a" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>';
    if (code === 2) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#b08968" stroke-width="2"><circle cx="8" cy="10" r="4" stroke="#e9c46a"/><line x1="8" y1="4" x2="8" y2="5" stroke="#e9c46a"/><line x1="3" y1="10" x2="4" y2="10" stroke="#e9c46a"/><path d="M18 10h-1.26A5 5 0 0 0 12 6a4.97 4.97 0 0 0-3 1"/><path d="M18 10a3 3 0 1 1 0 6H10"/></svg>';
    if (code === 3) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z"/></svg>';
    if (code >= 45 && code <= 48) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z"/><line x1="4" y1="16" x2="8" y2="16" opacity=".5"/><line x1="10" y1="16" x2="14" y2="16" opacity=".5"/></svg>';
    if (code >= 51 && code <= 55) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#4a90d9" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z" stroke="#888"/><line x1="8" y1="22" x2="8" y2="20"/><line x1="12" y1="22" x2="12" y2="20"/></svg>';
    if (code >= 61 && code <= 67) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#4a90d9" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z" stroke="#888"/><line x1="7" y1="22" x2="7" y2="18"/><line x1="11" y1="22" x2="11" y2="18"/><line x1="15" y1="22" x2="15" y2="18"/></svg>';
    if (code >= 71 && code <= 77) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#7b9ec4" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z" stroke="#888"/><circle cx="8" cy="21" r="1" fill="#7b9ec4"/><circle cx="12" cy="19" r="1" fill="#7b9ec4"/><circle cx="16" cy="21" r="1" fill="#7b9ec4"/></svg>';
    if (code >= 80 && code <= 82) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#4a90d9" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z" stroke="#555"/><line x1="7" y1="22" x2="8" y2="18"/><line x1="11" y1="22" x2="12" y2="18"/><line x1="15" y1="22" x2="16" y2="18"/></svg>';
    if (code >= 85 && code <= 86) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#7b9ec4" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z" stroke="#555"/><circle cx="8" cy="20" r="1" fill="#7b9ec4"/><circle cx="12" cy="22" r="1" fill="#7b9ec4"/><circle cx="16" cy="20" r="1" fill="#7b9ec4"/></svg>';
    if (code >= 95) return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 1 0 0-10z"/><polyline points="13 16 11 20 15 20 13 24" stroke="#e9c46a" stroke-width="2"/></svg>';
    return '<svg class="w-icon" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><circle cx="12" cy="12" r="5"/></svg>';
}

function difficultyLabel(sac) {
    const m = {'hiking':'Easy','mountain_hiking':'Moderate','demanding_mountain_hiking':'Hard','alpine_hiking':'Expert','demanding_alpine_hiking':'Expert+','difficult_alpine_hiking':'Extreme'};
    return m[sac] || '';
}

async function loadTrail() {
    let trailConditionPin = null;
    try {
    // Pass way_ids from URL params if present (merged trail segments)
    const urlParams = new URLSearchParams(window.location.search);
    const wayIds = urlParams.get('way_ids') || '';
    const trailApiUrl = wayIds ? `/api/trail/${FID}?way_ids=${wayIds}` : `/api/trail/${FID}`;
    const [trailRes, reportsRes] = await Promise.all([
        fetch(trailApiUrl),
        fetch(`/api/trail/${REPORT_KEY}/reports`)
    ]);
    const trail = await trailRes.json();
    const reports = await reportsRes.json();
    if (trail.error) { document.getElementById('trailContent').innerHTML = `<p>Trail not found: ${trail.error}</p>`; return; }
    
    const diff = difficultyLabel(trail.difficulty);
    const distKm = trail.distance_km || trail.distance_tag;
    const distMi = trail.distance_km ? (trail.distance_km * 0.621371).toFixed(1) : null;
    
    let html = `<a href="javascript:void(0)" onclick="history.back()" class="back-link">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/></svg>
        Back to Search
    </a>`;
    html += `<h1>${trail.name}</h1>`;
    
    // Location subtext (city, state, public land)
    if (trail.location) {
        const loc = trail.location;
        const parts = [];
        if (loc.city) parts.push(loc.city);
        if (loc.state) parts.push(loc.state);
        const locText = parts.join(', ');
        const landText = loc.public_land || '';
        if (locText || landText) {
            html += `<p class="trail-location-sub">`;
            html += `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 1 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>`;
            if (locText) html += locText;
            if (locText && landText) html += ` · `;
            if (landText) html += `${landText}`;
            html += `</p>`;
        }
    }
    
    // Trail info
    const surfaceLabel = trail.surface ? trail.surface.charAt(0).toUpperCase() + trail.surface.slice(1) : '';
    const typeMap = {'ground':'Dirt','dirt':'Dirt','earth':'Dirt','gravel':'Gravel','paved':'Paved','asphalt':'Paved','concrete':'Paved','compacted':'Compacted','fine_gravel':'Gravel','wood':'Boardwalk','grass':'Grass','sand':'Sand','rock':'Rock','paving_stones':'Paved'};
    const trailType = trail.surface ? (typeMap[trail.surface.toLowerCase()] || surfaceLabel) : '';
    
    // Activity icons
    const activitySvgs = {
        hiking: '<svg class="activity-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="4" r="2"/><path d="M7 21l3-9 2 3 2-3 3 9"/><path d="M10 12l-2-4h8l-2 4"/></svg>',
        biking: '<svg class="activity-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="17" r="3"/><circle cx="18" cy="17" r="3"/><path d="M6 17l3-7h4l2 3h3"/><circle cx="12" cy="7" r="1.5"/></svg>',
        horse: '<svg class="activity-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 16c0-4 3-7 7-7h2l3-4 2 1-2 3h2c2 0 3 2 3 4v3h-2v2h-2v-2H8v2H6v-2H4v-3z"/><circle cx="16" cy="11" r="1" fill="currentColor"/></svg>',
    };
    const activityLabels = {hiking: 'Hiking', biking: 'Biking', horse: 'Horseback'};
    
    // Use USGS length if available, otherwise computed
    const usgsLength = trail.length_miles;
    
    html += `<div class="trail-details-grid">`;
    if (trailType) html += `<div class="trail-detail-item"><span class="detail-label">Trail Type</span><span class="detail-value">${trailType}</span></div>`;
    if (trail.usgs_trail_type) html += `<div class="trail-detail-item"><span class="detail-label">USGS Type</span><span class="detail-value">${trail.usgs_trail_type}</span></div>`;
    if (diff) html += `<div class="trail-detail-item"><span class="detail-label">Difficulty</span><span class="detail-value">${diff}</span></div>`;
    if (usgsLength) html += `<div class="trail-detail-item"><span class="detail-label">Length</span><span class="detail-value">${usgsLength} mi</span></div>`;
    else if (distMi) html += `<div class="trail-detail-item"><span class="detail-label">Length</span><span class="detail-value">${distMi} mi (${trail.distance_km} km)</span></div>`;
    else if (distKm) html += `<div class="trail-detail-item"><span class="detail-label">Length</span><span class="detail-value">${distKm}</span></div>`;
    if (trail.activities && trail.activities.length) {
        const actHtml = trail.activities.map(a => `<span class="activity-tag">${activitySvgs[a] || ''} ${activityLabels[a] || a}</span>`).join(' ');
        html += `<div class="trail-detail-item"><span class="detail-label">Activities</span><span class="detail-value">${actHtml}</span></div>`;
    }
    if (trail.maintainer) html += `<div class="trail-detail-item"><span class="detail-label">Maintainer</span><span class="detail-value">${trail.maintainer}</span></div>`;
    if (trail.designation) html += `<div class="trail-detail-item"><span class="detail-label">Designation</span><span class="detail-value">${trail.designation}</span></div>`;
    if (trail.access) html += `<div class="trail-detail-item"><span class="detail-label">Access</span><span class="detail-value">${trail.access}</span></div>`;
    if (trail.wheelchair) html += `<div class="trail-detail-item"><span class="detail-label">Wheelchair</span><span class="detail-value">${trail.wheelchair}</span></div>`;
    if (trail.network) html += `<div class="trail-detail-item"><span class="detail-label">Network</span><span class="detail-value">${trail.network}</span></div>`;
    html += `</div>`;
    
    if (trail.desc) html += `<p class="trail-desc">${trail.desc}</p>`;
    if (trail.operator) html += `<p class="trail-operator">Managed by: ${trail.operator}</p>`;
    if (trail.website) html += `<p><a href="${trail.website}" target="_blank" rel="noopener">Official Website</a></p>`;
    
    // === ACCESS / VIA TRAIL BANNER ===
    if (trail.access_trail) {
        const at = trail.access_trail;
        html += `<div class="access-trail-banner">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg>
            <span>Accessed via <a href="/trail/${at.osm_type}/${at.osm_id}" class="via-trail-link">${at.name}</a></span>
        </div>`;
    } else if (trail.has_trailhead) {
        html += `<div class="trailhead-badge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 1 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>
            <span>Direct trailhead access (road/parking nearby)</span>
        </div>`;
    }
    
    // === TRAIL SEGMENTS ===
    if (trail.segments && trail.segments.length > 1) {
        html += `<div class="section-block trail-segments">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 19l4-4m4-4l4-4M9 5l-5 5m10 4l5 5"/></svg>
                Trail Segments
            </h2>
            <p class="muted">Click a segment to highlight it on the map</p>
            <div class="segments-list">`;
        const segColors = ['#c44536','#2d6a4f','#4a90d9','#b08968','#7f5539','#52b788','#e9c46a','#9b59b6'];
        trail.segments.forEach((seg, idx) => {
            const color = segColors[idx % segColors.length];
            const distLabel = seg.distance_mi > 0 ? `${seg.distance_mi} mi` : '';
            const surfLabel = seg.surface ? seg.surface.charAt(0).toUpperCase() + seg.surface.slice(1) : '';
            html += `<div class="segment-card" data-seg-idx="${idx}" style="border-left: 4px solid ${color}">
                <div class="segment-header">
                    <span class="segment-color" style="background:${color}"></span>
                    <strong>${seg.name}</strong>
                </div>
                <div class="segment-meta">
                    ${distLabel ? `<span class="tag">${distLabel}</span>` : ''}
                    ${surfLabel ? `<span class="tag">${surfLabel}</span>` : ''}
                    ${seg.difficulty ? `<span class="tag">${difficultyLabel(seg.difficulty)}</span>` : ''}
                </div>
            </div>`;
        });
        html += `</div></div>`;
    }
    
    // === ACTION BUTTONS (matching homepage hero button style) ===
    const reportUrl = `/report?trail=${encodeURIComponent(trail.name)}&id=${OSM_TYPE}:${OSM_ID}`;
    html += `<div class="trail-action-buttons">
        <div class="trail-btn-wrap">
            <a href="${reportUrl}" class="btn-hero-trail">Submit Full Report</a>
            <p class="btn-note-trail">In-depth report to help the community know what to expect</p>
        </div>
        <div class="trail-btn-wrap">
            <button class="btn-hero-trail" id="openQuickLogTrail">Conditions Quick Log</button>
            <p class="btn-note-trail">Quickly report conditions and hazards in a few taps</p>
        </div>
    </div>`;
    
    // === CONDITIONS SECTION (TOP) — Two columns ===
    html += `<div class="conditions-dual">`;
    
    // Left: Community-based conditions
    const commSummary = reports && reports.length ? 
        `${reports[0].trail_condition || 'Unknown'} · ${reports.length} report${reports.length !== 1 ? 's' : ''}` : 
        'No reports yet';
    html += `<div class="condition-panel" id="communityConditions">
        <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Trail Conditions Based On Community
        </h2>
        <div class="panel-summary">${commSummary}</div>
        <div class="panel-details">
            <div id="reportsList">${renderReports(reports)}</div>
        </div>
    </div>`;
    
    // Middle: Weather-based conditions
    html += `<div class="condition-panel" id="weatherConditions">
        <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
            Predicted Trail Conditions Based On Previous Weather
        </h2>
        <p class="muted">Loading weather data...</p>
    </div>`;
    
    // Right: Air Quality
    html += `<div class="condition-panel" id="airQualityPanel">
        <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2c3 0 5 2 8 2s4-1 4-1v11s-1 1-4 1-5-2-8-2-4 1-4 1V2s1-1 4-1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
            Air Quality
        </h2>
        <p class="muted">Loading air quality...</p>
    </div>`;
    
    html += `</div>`;

    // === STREAM GAUGES & NPS ALERTS — side by side ===
    html += `<div class="conditions-dual" style="margin-top:0;">`;

    // Water Crossings & Stream Levels
    html += `<div class="condition-panel" id="streamGaugesPanel">
        <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12c2-2 4-2 6 0s4 2 6 0 4-2 6 0"/><path d="M2 18c2-2 4-2 6 0s4 2 6 0 4-2 6 0"/><path d="M2 6c2-2 4-2 6 0s4 2 6 0 4-2 6 0"/></svg>
            Water Crossings &amp; Stream Levels
        </h2>
        <p class="muted">Loading water data...</p>
    </div>`;

    // NPS Alerts
    html += `<div class="condition-panel" id="npsAlertsPanel">
        <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            NPS Trail Alerts
        </h2>
        <p class="muted">Loading alerts...</p>
    </div>`;

    html += `</div>`;
    
    // === SUBMIT REPORT ===
    html += `<div class="section-block">
        <h2>Submit a Condition Report</h2>
        <form id="reportForm" class="report-form">
            <div class="form-row">
                <label>Overall Condition<select name="trail_condition"><option>Great</option><option>Good</option><option>Fair</option><option>Poor</option></select></label>
                <label>Trail Surface<select name="trail_surface"><option>Dry</option><option>Muddy</option><option>Snowy</option><option>Icy</option></select></label>
                <label>Road Access<select name="road_access"><option>Open</option><option>Rough</option><option>Closed</option></select></label>
            </div>
            <label>Notes<textarea name="general_notes" rows="2" placeholder="What did you see out there?"></textarea></label>
            <label>Date Visited<input type="date" name="date_visited" value="${new Date().toISOString().slice(0,10)}"></label>
            <button type="submit" class="btn btn-primary">Submit Report</button>
        </form>
    </div>`;
    
    // === MAP (BOTTOM) ===
    if (trail.lat && trail.lon) {
        html += `<div class="section-block">
            <h2>Trail Map</h2>
            <div id="trailMap" class="trail-map"></div>
            <label class="toggle-label"><input type="checkbox" id="overlayToggle" checked> Show hiking trails overlay</label>
        </div>`;
    }
    
    // === ELEVATION PROFILE (below map) ===
    if (trail.geometry && trail.geometry.length > 2) {
        html += `<div class="section-block" id="elevationSection">
            <h2>Elevation Profile</h2>
            <p class="muted">Loading elevation data...</p>
        </div>`;
    }
    
    // OSM attribution
    const usgsAttr = trail.usgs_enriched ? ' &amp; <a href="https://www.usgs.gov/programs/national-geospatial-program/national-map" target="_blank">USGS National Map</a>' : '';
    html += `<p class="muted" style="margin-top:2rem;font-size:0.8rem">Trail data from <a href="https://www.openstreetmap.org/${OSM_TYPE}/${OSM_ID}" target="_blank">OpenStreetMap</a>${usgsAttr}</p>`;
    
    document.getElementById('trailContent').innerHTML = html;
    
    // Init map
    let trailMap = null;
    let elevMarker = null;
    if (trail.lat && trail.lon) {
        const BASEMAPS = {
            carto: {url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', attr: '&copy; OSM &copy; CARTO', subdomains: 'abcd', maxZoom: 20},
            topo: {url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', attr: '&copy; OSM &copy; OpenTopoMap', subdomains: 'abc', maxZoom: 17},
            satellite: {url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', attr: '&copy; Esri', maxZoom: 19},
            terrain: {url: 'https://{s}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey=6170aad10dfd42a38d4d8c709a536f38', attr: '&copy; Thunderforest &copy; OSM', subdomains: 'abc', maxZoom: 22},
        };
        const map = L.map('trailMap').setView([trail.lat, trail.lon], 13);
        trailMap = map;
        const savedBase = localStorage.getItem('tc_basemap') || 'carto';
        const baseCfg = BASEMAPS[savedBase] || BASEMAPS.carto;
        let currentBase = L.tileLayer(baseCfg.url, {attribution: baseCfg.attr, subdomains: baseCfg.subdomains || '', maxZoom: baseCfg.maxZoom || 20}).addTo(map);
        
        // Use first geometry point (trailhead) for pin if available
        const pinLat = (trail.geometry && trail.geometry.length > 0) ? trail.geometry[0].lat : trail.lat;
        const pinLon = (trail.geometry && trail.geometry.length > 0) ? trail.geometry[0].lon : trail.lon;

        // Add condition pin marker (will be updated after weather loads)
        const condPinIcon = L.icon({
            iconUrl: '/static/pins/cond-clear.svg',
            iconSize: [40, 50], iconAnchor: [20, 50], popupAnchor: [0, -50]
        });
        trailConditionPin = L.marker([pinLat, pinLon], {icon: condPinIcon})
            .addTo(map).bindPopup(trail.name);
        
        const segColors = ['#c44536','#2d6a4f','#4a90d9','#b08968','#7f5539','#52b788','#e9c46a','#9b59b6'];
        const segPolylines = [];
        
        if (trail.segments && trail.segments.length > 1) {
            // Draw each segment as a separate colored polyline
            const allBounds = L.latLngBounds();
            trail.segments.forEach((seg, idx) => {
                if (!seg.geometry || seg.geometry.length < 2) return;
                const latlngs = seg.geometry.map(p => [p.lat, p.lon]);
                const color = segColors[idx % segColors.length];
                const poly = L.polyline(latlngs, {color, weight: 4, opacity: 0.8}).addTo(map);
                poly.bindPopup(`<strong>${seg.name}</strong><br>${seg.distance_mi} mi${seg.surface ? ' · ' + seg.surface : ''}`);
                segPolylines.push(poly);
                allBounds.extend(poly.getBounds());
            });
            if (allBounds.isValid()) map.fitBounds(allBounds, {padding: [30, 30]});
        } else if (trail.geometry && trail.geometry.length > 1) {
            // Single trail — draw as one polyline
            const latlngs = trail.geometry.map(p => [p.lat, p.lon]);
            const polyline = L.polyline(latlngs, {color: '#c44536', weight: 4, opacity: 0.8}).addTo(map);
            map.fitBounds(polyline.getBounds(), {padding: [30, 30]});
        } else {
            trailConditionPin.openPopup();
        }
        
        // Segment click-to-highlight from cards
        if (trail.segments && trail.segments.length > 1) {
            document.querySelectorAll('.segment-card').forEach(card => {
                card.addEventListener('click', function() {
                    const idx = parseInt(this.dataset.segIdx);
                    // Reset all to normal weight
                    segPolylines.forEach((p, i) => {
                        p.setStyle({weight: i === idx ? 7 : 3, opacity: i === idx ? 1.0 : 0.4});
                    });
                    // Highlight the selected card
                    document.querySelectorAll('.segment-card').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    // Pan to segment
                    if (segPolylines[idx]) {
                        map.fitBounds(segPolylines[idx].getBounds(), {padding: [40, 40]});
                        segPolylines[idx].openPopup();
                    }
                });
            });
            
            // Click map background to reset highlights
            map.on('click', function() {
                segPolylines.forEach(p => p.setStyle({weight: 4, opacity: 0.8}));
                document.querySelectorAll('.segment-card').forEach(c => c.classList.remove('active'));
            });
        }
        
        // Water crossing markers
        if (trail.water_crossings && trail.water_crossings.length > 0) {
            trail.water_crossings.forEach(c => {
                if (!c.lat || !c.lon) return;
                const isFord = c.type === 'ford';
                const marker = L.circleMarker([c.lat, c.lon], {
                    radius: 7,
                    color: isFord ? '#c44536' : '#1565c0',
                    fillColor: isFord ? '#c44536' : '#1565c0',
                    fillOpacity: 0.8,
                    weight: 2,
                });
                const label = isFord ? 'Water Ford' : 'Bridge';
                const extra = c.name ? `<br>${c.name}` : '';
                const depth = c.depth ? `<br>Depth: ${c.depth}` : '';
                marker.bindPopup(`<strong>${label}</strong>${extra}${depth}`);
                marker.addTo(map);
            });
        }
        
        const hikingOverlay = L.tileLayer('https://tile.waymarkedtrails.org/hiking/{z}/{x}/{y}.png', {opacity: 0.7, attribution:'Waymarked Trails'});
        hikingOverlay.addTo(map);
        document.getElementById('overlayToggle').addEventListener('change', function() {
            this.checked ? hikingOverlay.addTo(map) : map.removeLayer(hikingOverlay);
        });
    }
    
    // Init collapsible for community panel (rendered inline, not async)
    initCollapsible('communityConditions');
    
    // Load elevation + weather + air quality in parallel (don't let one block the other)
    const elevationPromise = loadElevation(trail, trailMap);
    const weatherPromise = loadWeather(trail, trailConditionPin);
    const aqPromise = loadAirQuality(trail);
    const streamsPromise = loadStreams(trail);
    const alertsPromise = loadAlerts(trail);
    
    // Await all (each handles its own errors)
    await Promise.all([elevationPromise, weatherPromise, aqPromise, streamsPromise, alertsPromise]);
    
    // Report form handler
    document.getElementById('reportForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const fd = new FormData(this);
        const data = Object.fromEntries(fd);
        await fetch(`/api/trail/${REPORT_KEY}/reports`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
        this.reset();
        const rr = await fetch(`/api/trail/${REPORT_KEY}/reports`);
        document.getElementById('reportsList').innerHTML = renderReports(await rr.json());
    });
    
    } catch(e) {
        console.error('loadTrail error:', e);
        document.getElementById('trailContent').innerHTML = `<p>Error loading trail data. Please try refreshing.</p>`;
    }
}

async function loadElevation(trail, trailMap) {
    if (!trail.geometry || trail.geometry.length <= 2) return;
    let elevMarker = null;
    
    try {
        const pts = trail.geometry;
        const step = Math.max(1, Math.floor(pts.length / 100));
        const sampled = pts.filter((_, i) => i % step === 0);
        if (sampled[sampled.length - 1] !== pts[pts.length - 1]) sampled.push(pts[pts.length - 1]);
        
        const lats = sampled.map(p => p.lat.toFixed(5)).join(',');
        const lons = sampled.map(p => p.lon.toFixed(5)).join(',');
        
        const eRes = await fetch(`/api/elevation?lats=${lats}&lons=${lons}`);
        const eData = await eRes.json();
            if (eData.elevation && eData.elevation.length) {
                const elev = eData.elevation;
                const minE = Math.min(...elev);
                const maxE = Math.max(...elev);
                const gainM = elev.reduce((acc, v, i) => i > 0 && v > elev[i-1] ? acc + (v - elev[i-1]) : acc, 0);
                const minFt = Math.round(minE * 3.281);
                const maxFt = Math.round(maxE * 3.281);
                const gainFt = Math.round(gainM * 3.281);
                
                let ehtml = `<div class="elev-stats">
                    <div class="elev-stat"><span class="detail-label">Min Elevation</span><span class="detail-value">${minFt} ft</span></div>
                    <div class="elev-stat"><span class="detail-label">Max Elevation</span><span class="detail-value">${maxFt} ft</span></div>
                    <div class="elev-stat"><span class="detail-label">Elevation Gain</span><span class="detail-value">${gainFt} ft</span></div>
                </div>
                <canvas id="elevChart" width="800" height="200" class="elev-chart"></canvas>`;
                document.getElementById('elevationSection').innerHTML = `<h2>Elevation Profile</h2>${ehtml}`;
                
                // Draw chart
                const canvas = document.getElementById('elevChart');
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                const pad = {top: 10, right: 10, bottom: 25, left: 50};
                const cw = w - pad.left - pad.right;
                const ch = h - pad.top - pad.bottom;
                const range = maxE - minE || 1;
                
                function drawChart(highlightIdx) {
                    ctx.clearRect(0, 0, w, h);
                    
                    // Background
                    ctx.fillStyle = '#fdfbf7';
                    ctx.fillRect(0, 0, w, h);
                    
                    // Grid lines
                    ctx.strokeStyle = '#e8e0d4';
                    ctx.lineWidth = 1;
                    for (let i = 0; i <= 4; i++) {
                        const y = pad.top + (ch / 4) * i;
                        ctx.beginPath();
                        ctx.moveTo(pad.left, y);
                        ctx.lineTo(w - pad.right, y);
                        ctx.stroke();
                        
                        const elevVal = Math.round((maxE - (range / 4) * i) * 3.281);
                        ctx.fillStyle = '#b08968';
                        ctx.font = '11px Nunito, sans-serif';
                        ctx.textAlign = 'right';
                        ctx.fillText(`${elevVal}ft`, pad.left - 5, y + 4);
                    }
                    
                    // Fill area
                    ctx.beginPath();
                    ctx.moveTo(pad.left, pad.top + ch);
                    for (let i = 0; i < elev.length; i++) {
                        const x = pad.left + (i / (elev.length - 1)) * cw;
                        const y = pad.top + ch - ((elev[i] - minE) / range) * ch;
                        ctx.lineTo(x, y);
                    }
                    ctx.lineTo(pad.left + cw, pad.top + ch);
                    ctx.closePath();
                    ctx.fillStyle = 'rgba(45, 106, 79, 0.15)';
                    ctx.fill();
                    
                    // Line
                    ctx.beginPath();
                    for (let i = 0; i < elev.length; i++) {
                        const x = pad.left + (i / (elev.length - 1)) * cw;
                        const y = pad.top + ch - ((elev[i] - minE) / range) * ch;
                        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                    }
                    ctx.strokeStyle = '#2d6a4f';
                    ctx.lineWidth = 2.5;
                    ctx.stroke();
                    
                    // Highlight point
                    if (highlightIdx != null && highlightIdx >= 0 && highlightIdx < elev.length) {
                        const hx = pad.left + (highlightIdx / (elev.length - 1)) * cw;
                        const hy = pad.top + ch - ((elev[highlightIdx] - minE) / range) * ch;
                        
                        // Vertical line
                        ctx.strokeStyle = '#c44536';
                        ctx.lineWidth = 1.5;
                        ctx.setLineDash([4, 3]);
                        ctx.beginPath();
                        ctx.moveTo(hx, pad.top);
                        ctx.lineTo(hx, pad.top + ch);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        // Dot
                        ctx.beginPath();
                        ctx.arc(hx, hy, 5, 0, Math.PI * 2);
                        ctx.fillStyle = '#c44536';
                        ctx.fill();
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        // Label
                        const ft = Math.round(elev[highlightIdx] * 3.281);
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 12px Nunito, sans-serif';
                        ctx.textAlign = hx > w / 2 ? 'right' : 'left';
                        ctx.fillText(`${ft} ft`, hx + (hx > w / 2 ? -10 : 10), hy - 10);
                    }
                }
                
                drawChart(null);
                
                // Interactive: mouse/touch on canvas → show point on map
                function getIdxFromEvent(e) {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = w / rect.width;
                    let clientX;
                    if (e.touches) clientX = e.touches[0].clientX;
                    else clientX = e.clientX;
                    const mx = (clientX - rect.left) * scaleX;
                    const relX = (mx - pad.left) / cw;
                    return Math.max(0, Math.min(elev.length - 1, Math.round(relX * (elev.length - 1))));
                }
                
                function showPoint(idx) {
                    drawChart(idx);
                    if (trailMap && sampled[idx]) {
                        const pt = sampled[idx];
                        if (elevMarker) trailMap.removeLayer(elevMarker);
                        elevMarker = L.circleMarker([pt.lat, pt.lon], {
                            radius: 8, color: '#c44536', fillColor: '#c44536', fillOpacity: 1, weight: 2, stroke: true, className: 'elev-marker'
                        }).addTo(trailMap).bindPopup(`${Math.round(elev[idx] * 3.281)} ft`, {closeButton: false, offset: [0, -10]}).openPopup();
                    }
                }
                
                canvas.addEventListener('mousemove', e => showPoint(getIdxFromEvent(e)));
                canvas.addEventListener('touchmove', e => { e.preventDefault(); showPoint(getIdxFromEvent(e)); }, {passive: false});
                canvas.addEventListener('mouseleave', () => {
                    drawChart(null);
                    if (elevMarker && trailMap) { trailMap.removeLayer(elevMarker); elevMarker = null; }
                });
                canvas.style.cursor = 'crosshair';
            }
    } catch(e) {
        console.error('Elevation load error:', e);
        const elevSec = document.getElementById('elevationSection');
        if (elevSec) elevSec.innerHTML = '<h2>Elevation Profile</h2><p class="muted">Could not load elevation data</p>';
    }
}

async function loadAirQuality(trail) {
    if (!trail.lat || !trail.lon) return;
    const panel = document.getElementById('airQualityPanel');
    try {
        const res = await fetch(`/api/airquality?lat=${trail.lat.toFixed(4)}&lon=${trail.lon.toFixed(4)}`);
        const aq = await res.json();
        if (aq.error) {
            panel.querySelector('.muted').textContent = 'Air quality data unavailable';
            return;
        }
        const aqi = aq.us_aqi || 0;
        const label = aq.label || 'Unknown';
        let color = '#2d9a2d';
        let textColor = 'white';
        if (aqi > 300) color = '#7e0023';
        else if (aqi > 200) color = '#8f3f97';
        else if (aqi > 150) color = '#ff0000';
        else if (aqi > 100) color = '#ff7e00';
        else if (aqi > 50) { color = '#d4a017'; textColor = '#333'; }
        else { textColor = 'white'; }
        
        let html = `<div class="condition-badge" style="background:${color};color:${textColor}">${label.toUpperCase()}</div>`;
        html += `<div class="aqi-value" style="color:${color};font-size:2em;font-weight:800;margin:0.5rem 0;">AQI ${aqi}</div>`;
        html += `<div class="aqi-details">`;
        if (aq.pm2_5 != null) html += `<p class="reason">PM2.5: ${aq.pm2_5.toFixed(1)} µg/m³</p>`;
        if (aq.pm10 != null) html += `<p class="reason">PM10: ${aq.pm10.toFixed(1)} µg/m³</p>`;
        if (aq.ozone != null) html += `<p class="reason">Ozone: ${aq.ozone.toFixed(1)} µg/m³</p>`;
        if (aq.no2 != null) html += `<p class="reason">NO₂: ${aq.no2.toFixed(1)} µg/m³</p>`;
        html += `</div>`;
        
        const aqSummary = `AQI ${aqi} · ${label}`;
        panel.innerHTML = `<h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2c3 0 5 2 8 2s4-1 4-1v11s-1 1-4 1-5-2-8-2-4 1-4 1V2s1-1 4-1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
            Air Quality</h2>
            <div class="panel-summary">${aqSummary}</div>
            <div class="panel-details">${html}</div>`;
        initCollapsible('airQualityPanel');
    } catch(e) {
        console.error('AQ load error:', e);
        panel.querySelector('.muted').textContent = 'Could not load air quality';
    }
}

async function loadWeather(trail, trailConditionPin) {
    if (!trail.lat || !trail.lon) return;
    
    try {
        const wr = await fetch(`/api/weather/history?lat=${trail.lat}&lon=${trail.lon}`);
        const w = await wr.json();
        if (w.error) {
            console.error('Weather API error:', w.error);
            document.getElementById('weatherConditions').querySelector('.muted').textContent = 'Weather data unavailable';
            return;
        }
        
        let whtml = '';
        const tempF = Math.round(w.current.temp_c * 9/5 + 32);
        const wDesc = weatherDescriptions[w.current.weathercode] || 'Unknown';
        
        whtml += `<div class="weather-current"><span class="weather-temp">${tempF}°F</span> <span class="weather-desc">${wDesc}</span></div>`;
        whtml += `<div class="weather-wind">Wind: ${w.current.windspeed} km/h</div>`;
        
        const inf = w.inference;
        whtml += `<div class="condition-badge" style="background:${inf.color}">${inf.condition.toUpperCase()}</div>`;
        
        // Update map pin to match condition
        if (trailConditionPin) {
            const condIconMap = {
                'clear': '/static/pins/cond-clear.svg', 'dry': '/static/pins/cond-clear.svg',
                'wet': '/static/pins/cond-wet.svg', 'muddy': '/static/pins/cond-muddy.svg',
                'snowy': '/static/pins/cond-snowy.svg', 'icy': '/static/pins/cond-icy.svg',
                'closed': '/static/pins/cond-closed.svg',
            };
            trailConditionPin.setIcon(L.icon({
                iconUrl: condIconMap[inf.condition] || condIconMap['clear'],
                iconSize: [40, 50], iconAnchor: [20, 50], popupAnchor: [0, -50],
            }));
        }
        
        whtml += `<div class="condition-reasons">`;
        inf.reasons.forEach(r => { whtml += `<p class="reason">${r}</p>`; });
        whtml += `</div>`;
        
        whtml += `<div class="weather-history"><h3>7-Day History</h3><div class="history-grid">`;
        const codes = w.daily.codes || [];
        for (let i = 0; i < (w.daily.dates||[]).length; i++) {
            const d = w.daily.dates[i];
            const hi = w.daily.temp_max[i] != null ? Math.round(w.daily.temp_max[i]*9/5+32) : '--';
            const lo = w.daily.temp_min[i] != null ? Math.round(w.daily.temp_min[i]*9/5+32) : '--';
            const precip = w.daily.precip[i] || 0;
            const snow = w.daily.snow[i] || 0;
            const code = codes[i] != null ? codes[i] : 0;
            whtml += `<div class="history-day">${weatherIcon(code)}<div class="hd-date">${d.slice(5)}</div><div class="hd-temp">${hi}/${lo}°F</div>${precip > 0 ? `<div class="hd-precip">${precip}mm rain</div>` : ''}${snow > 0 ? `<div class="hd-snow">${snow}cm snow</div>` : ''}</div>`;
        }
        whtml += `</div></div>`;
        
        const weatherSummary = `${tempF}°F · ${inf.condition.charAt(0).toUpperCase() + inf.condition.slice(1)} · ${wDesc}`;
        document.getElementById('weatherConditions').innerHTML = `<h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
            Predicted Trail Conditions Based On Previous Weather</h2>
            <div class="panel-summary">${weatherSummary}</div>
            <div class="panel-details">${whtml}</div>`;
        initCollapsible('weatherConditions');
    } catch(e) {
        console.error('Weather load error:', e);
        const wc = document.getElementById('weatherConditions');
        if (wc) wc.querySelector('.muted').textContent = 'Could not load weather data';
    }
}

function renderReports(reports) {
    if (!reports || !reports.length) return '<p class="muted">No Reports Made</p>';
    
    // Synthesize community condition from latest reports
    const latest = reports[0];
    let synthesis = `<div class="community-synthesis">
        <div class="condition-badge" style="background:${conditionColor(latest.trail_condition)};color:${conditionTextColor(latest.trail_condition)}">${(latest.trail_condition || 'Unknown').toUpperCase()}</div>
        ${latest.trail_surface ? `<span class="tag">${latest.trail_surface}</span>` : ''}
        ${latest.road_access ? `<span class="tag">Road: ${latest.road_access}</span>` : ''}
        <p class="muted" style="margin-top:0.5rem">Based on ${reports.length} report${reports.length !== 1 ? 's' : ''}</p>
    </div>`;
    
    synthesis += `<div class="reports-list">`;
    synthesis += reports.map(r => `<div class="report">
        <div class="report-header">
            <span class="report-condition tag" style="background:${conditionColor(r.trail_condition)};color:${conditionTextColor(r.trail_condition)}">${r.trail_condition || ''}</span>
            ${r.trail_surface ? `<span class="tag">${r.trail_surface}</span>` : ''}
            ${r.road_access ? `<span class="tag">Road: ${r.road_access}</span>` : ''}
            <span class="report-date">${r.date_visited || r.created_at?.slice(0,10) || ''}</span>
        </div>
        ${r.general_notes ? `<p class="report-notes">${r.general_notes}</p>` : ''}
        <div class="report-votes">
            <button onclick="vote(${r.id},'up')" class="vote-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5m-7 7l7-7 7 7"/></svg>
                ${r.upvotes||0}
            </button>
            <button onclick="vote(${r.id},'down')" class="vote-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14m7-7l-7 7-7-7"/></svg>
                ${r.downvotes||0}
            </button>
        </div>
    </div>`).join('');
    synthesis += `</div>`;
    return synthesis;
}

function conditionColor(cond) {
    if (!cond) return '#6c757d';
    const c = cond.toLowerCase();
    if (c === 'great') return '#2d6a4f';
    if (c === 'good') return '#52b788';
    if (c === 'fair') return '#d4a017';
    if (c === 'poor') return '#c44536';
    return '#6c757d';
}

function conditionTextColor(cond) {
    if (!cond) return 'white';
    const c = cond.toLowerCase();
    if (c === 'fair') return '#333';
    return 'white';
}

async function vote(id, type) {
    await fetch(`/api/reports/${id}/vote`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({vote_type: type})});
    const rr = await fetch(`/api/trail/${REPORT_KEY}/reports`);
    document.getElementById('reportsList').innerHTML = renderReports(await rr.json());
}

loadTrail().catch(e => console.error('loadTrail uncaught:', e)).then(() => {
    const qlBtn = document.getElementById('openQuickLogTrail');
    if (qlBtn) {
        qlBtn.addEventListener('click', function() {
            // TODO: open Quick Log modal when built; for now go to report page
            const reportUrl = `/report?trail=${encodeURIComponent(document.querySelector('h1')?.textContent || '')}&id=${REPORT_KEY}`;
            window.location = reportUrl;
        });
    }
});

// ═══ Stream/River Gauges ═══
async function loadStreams(trail) {
    const panel = document.getElementById('streamGaugesPanel');
    if (!panel) return;

    const waterIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12c2-2 4-2 6 0s4 2 6 0 4-2 6 0"/><path d="M2 18c2-2 4-2 6 0s4 2 6 0 4-2 6 0"/><path d="M2 6c2-2 4-2 6 0s4 2 6 0 4-2 6 0"/></svg>`;
    const crossings = trail.water_crossings || [];
    const fords = crossings.filter(c => c.type === 'ford');
    const bridges = crossings.filter(c => c.type === 'bridge');

    // Build summary text
    const sumParts = [];
    if (bridges.length > 0) sumParts.push(`${bridges.length} bridge${bridges.length > 1 ? 's' : ''}`);
    if (fords.length > 0) sumParts.push(`${fords.length} ford${fords.length > 1 ? 's' : ''}`);
    if (!crossings.length) sumParts.push('No crossings detected');

    let details = '';

    // Water crossings detail
    if (crossings.length > 0) {
        const cParts = [];
        if (bridges.length > 0) cParts.push(`${bridges.length} bridge${bridges.length > 1 ? 's' : ''}`);
        if (fords.length > 0) cParts.push(`<strong>${fords.length} water ford${fords.length > 1 ? 's' : ''}</strong> (in-water crossing)`);
        details += `<div class="crossings-summary">${cParts.join(' · ')}</div>`;

        if (fords.length > 0) {
            details += `<div class="crossing-cards">`;
            fords.forEach(f => {
                details += `<div class="crossing-card ford">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#c44536" stroke-width="2"><path d="M2 12c2-2 4-2 6 0s4 2 6 0 4-2 6 0"/><path d="M2 6c2-2 4-2 6 0s4 2 6 0 4-2 6 0"/><line x1="7" y1="1" x2="7" y2="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="17" y1="1" x2="17" y2="5"/></svg>
                    <span>Water Ford${f.name ? ': ' + f.name : ''}${f.depth ? ' · Depth: ' + f.depth : ''}</span>
                </div>`;
            });
            details += `</div>`;
        }
        if (bridges.length > 0) {
            details += `<div class="crossing-cards">`;
            bridges.forEach(b => {
                details += `<div class="crossing-card bridge">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1565c0" stroke-width="2"><path d="M4 10h16M4 14h16"/><path d="M6 10V6M10 10V4M14 10V4M18 10V6"/><path d="M2 18l4-4M22 18l-4-4"/></svg>
                    <span>Bridge${b.name ? ': ' + b.name : ''}${b.material ? ' · ' + b.material : ''}</span>
                </div>`;
            });
            details += `</div>`;
        }
    } else {
        details += `<p class="muted" style="margin-bottom:12px;">No bridges or fords detected on this trail</p>`;
    }

    // Stream gauges
    if (trail.lat && trail.lon) {
        try {
            const res = await fetch(`/api/streams?lat=${trail.lat.toFixed(4)}&lon=${trail.lon.toFixed(4)}`);
            const data = await res.json();
            if (!data.error) {
                const gauges = data.gauges || [];
                if (gauges.length === 0) {
                    details += `<p class="muted">No USGS stream gauges found nearby</p>`;
                } else {
                    sumParts.push(`${gauges.length} gauge${gauges.length > 1 ? 's' : ''} nearby`);
                    details += `<h3 style="font-size:1rem;color:var(--brown);margin:16px 0 8px 0;">Nearby Stream Gauges</h3>`;
                    details += `<div class="stream-gauges">`;
                    for (const g of gauges) {
                        const levelBar = g.gage_height != null ? Math.min(100, (g.gage_height / 10) * 100) : 0;
                        details += `
                            <div class="stream-gauge-card">
                                <div class="sg-header">
                                    <span class="sg-name">${g.name}</span>
                                    <span class="sg-level-badge" style="background:${g.gage_height_color}">${g.gage_height_label}</span>
                                </div>
                                <div class="sg-stats">
                                    ${g.gage_height != null ? `<div class="sg-stat"><span class="sg-stat-label">Water Level</span><span class="sg-stat-value">${g.gage_height} ft</span></div>` : ''}
                                    ${g.streamflow != null ? `<div class="sg-stat"><span class="sg-stat-label">Flow Rate</span><span class="sg-stat-value">${g.streamflow} ft³/s · ${g.streamflow_label}</span></div>` : ''}
                                </div>
                                <div class="sg-bar-wrap"><div class="sg-bar" style="width:${levelBar}%;background:${g.gage_height_color}"></div></div>
                            </div>`;
                    }
                    details += `</div>`;
                }
            }
        } catch(e) {
            console.error('Stream gauge error:', e);
            details += `<p class="muted">Unable to load stream gauge data</p>`;
        }
    }

    details += `<p class="muted" style="font-size:0.75rem;margin-top:8px;">Stream data from <a href="https://waterservices.usgs.gov" target="_blank">USGS NWIS</a> · Crossings from <a href="https://www.openstreetmap.org" target="_blank">OpenStreetMap</a></p>`;

    panel.innerHTML = `<h2>${waterIcon} Water Crossings &amp; Stream Levels</h2>
        <div class="panel-summary">${sumParts.join(' · ')}</div>
        <div class="panel-details">${details}</div>`;
    initCollapsible('streamGaugesPanel');
}

// ═══ NPS Trail Alerts ═══
async function loadAlerts(trail) {
    const panel = document.getElementById('npsAlertsPanel');
    if (!panel || !trail.lat || !trail.lon) {
        if (panel) panel.querySelector('p').textContent = 'Location not available';
        return;
    }
    try {
        const res = await fetch(`/api/alerts?lat=${trail.lat.toFixed(4)}&lon=${trail.lon.toFixed(4)}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        const alerts = data.alerts || [];
        const alertIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`;

        const alertSummary = alerts.length === 0 ? 'No active alerts' : `${alerts.length} alert${alerts.length > 1 ? 's' : ''} nearby`;

        if (alerts.length === 0) {
            panel.innerHTML = `
                <h2>${alertIcon} NPS Trail Alerts</h2>
                <div class="panel-summary">${alertSummary}</div>
                <div class="panel-details">
                    <div class="nps-no-alerts">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2d6a4f" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        <span>No active alerts in this area</span>
                    </div>
                </div>`;
            initCollapsible('npsAlertsPanel');
            return;
        }

        let details = `<div class="nps-alerts-list">`;

        for (const a of alerts) {
            const catClass = a.category === 'Danger' || a.category === 'Park Closure' ? 'alert-danger' :
                             a.category === 'Caution' ? 'alert-caution' : 'alert-info';
            const distText = a.distance_km != null ? `${a.distance_km} km away` : '';
            details += `
                <div class="nps-alert-card ${catClass}">
                    <div class="nps-alert-header">
                        <span class="nps-alert-cat" style="color:${a.color}">${a.category}</span>
                        <span class="nps-alert-park">${a.park_name}${distText ? ' · ' + distText : ''}</span>
                    </div>
                    <div class="nps-alert-title">${a.title}</div>
                    <div class="nps-alert-desc">${a.description.length > 200 ? a.description.slice(0, 200) + '...' : a.description}</div>
                    ${a.url ? `<a href="${a.url}" target="_blank" class="nps-alert-link">More info</a>` : ''}
                </div>`;
        }

        details += `</div>
            <p class="muted" style="font-size:0.75rem;margin-top:8px;">Data from <a href="https://www.nps.gov" target="_blank">National Park Service</a></p>`;
        panel.innerHTML = `<h2>${alertIcon} NPS Trail Alerts</h2>
            <div class="panel-summary">${alertSummary}</div>
            <div class="panel-details">${details}</div>`;
        initCollapsible('npsAlertsPanel');
    } catch(e) {
        console.error('NPS alerts error:', e);
        panel.querySelector('p').textContent = 'Unable to load alerts';
    }
}
</script>
{% endblock %}
